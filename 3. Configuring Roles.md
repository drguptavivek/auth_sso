

# load env into your shell
  set -a
  source .env
  set +a

  # verify they’re set
  echo "user=$KC_BOOTSTRAP_ADMIN_USERNAME"
  echo "pass? ${KC_BOOTSTRAP_ADMIN_PASSWORD:+set}"

  # run kcadm
  sudo docker compose exec keycloak /opt/keycloak/bin/kcadm.sh config credentials \
    --server http://localhost:8080 \
    --realm master \
    --user "$KC_BOOTSTRAP_ADMIN_USERNAME" \
    --password "$KC_BOOTSTRAP_ADMIN_PASSWORD"

sudo docker  exec -it auth_sso-keycloak-1  bash


0) List REALMS

```bash
/opt/keycloak/bin/kcadm.sh get realms
```

 1) Groups (who they are)
  Create top-level groups: faculty, resident, student, nurse, lab_tech, research_staff, it_support, admin_staff.

```bash
  for g in faculty resident student nurse lab_tech research_staff it_support admin_staff; do
     /opt/keycloak/bin/kcadm.sh create groups -r AIIMS_internal -s name="$g" ||
  true
  done
```

  2) Realm roles (what they can do)
  Roles: app_user (baseline), clinical, it_admin.

```bash
  for r in app_user clinical it_admin; do
     /opt/keycloak/bin/kcadm.sh create roles -r AIIMS_internal -s name="$r" || true
  done
```

  3) User profile attribute: account_expiry (required date)
  Create via Admin UI (Realm Settings → User profile):

  - Name: account_expiry
  - Display name: Account Expiry
  - Required: always
  - Input type: date
  - Validator: pattern ^\d{4}-\d{2}-\d{2}$

  If you prefer CLI (requires Keycloak 22+ user profile endpoints): FROM HOST

```bash
 # 1) Pull current user-profile config to host
sudo rm /tmp/profile.json
sudo   docker exec auth_sso-keycloak-1 /opt/keycloak/bin/kcadm.sh get realms/AIIMS_internal/users/profile    > /tmp/profile.json
head /tmp/profile.json


   # 1) Append account_expiry to the pulled profile
 sudo rm /tmp/profile.with-expiry.json
   
 jq '.attributes = (.attributes // []) + [{
    "name": "account_expiry",
    "displayName": "Account Expiry",
    "required": { "roles": ["admin","user"] },
    "permissions": { "view": ["admin","user"], "edit": ["admin"] },
    "annotations": { "inputType": "date" },
    "validations": { "pattern": { "pattern": "^\\d{4}-\\d{2}-\\d{2}$" } },
    "group": "user-metadata",
    "multivalued": false
  }]' /tmp/profile.json > /tmp/profile.with-expiry.json

  # 2) Sanity-check JSON
  jq . /tmp/profile.with-expiry.json

  # 3) Apply to Keycloak
  sudo docker exec -i auth_sso-keycloak-1 /opt/keycloak/bin/kcadm.sh update realms/AIIMS_internal/users/profile -f -  < /tmp/profile.with-expiry.json

  # 4) Verify
  sudo docker exec auth_sso-keycloak-1 /opt/keycloak/bin/kcadm.sh get realms/AIIMS_internal/users/profile | grep -A5 account_expiry

```


## ATtache to Account-attrs


 Add the mapper to account-attrs, then make sure the scope is assigned:

  UI steps to add mapper

  1. Go to realm AIIMS_internal.
  2. Client scopes → click account-attrs.
  3. Mappers tab → Create.
      - Mapper type: “User Attribute”
      - Name: account_expiry
      - User Attribute: account_expiry
      - Token Claim Name: account_expiry
      - Claim JSON Type: String
      - Add to ID token: ON
      - Add to access token: ON
      - Add to userinfo: ON
  4. Save.

 In the Admin Console:

  1. Go to your realm: AIIMS_internal.
  2. Left menu: Client scopes → find account-attrs (or create it if missing).
  3. Select account-attrs, go to the Mappers tab and confirm the account_expiry mapper is there (add it if not).
  4. Make it a default scope:
      - Left menu: Realm settings → Client scopes tab.
      - In “Default client scopes”, click Add client scope → choose account-attrs → Add.
        (This makes it apply to all newly created clients.)
  5. To add it to existing clients:
      - Clients → click a client → Client scopes tab.
      - Under “Assigned default client scopes”, click Add client scope → pick account-attrs → Add.
      - Repeat for other clients as needed.

  After that, account_expiry will appear in tokens for new clients (and any existing clients you attach it to).

Ensure scope is default/assigned
  - Realm Settings → Client scopes tab → in “Default client scopes”, Add → select account-attrs → Add (applies to new clients).